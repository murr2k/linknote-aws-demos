# HiveMQ Cloud MQTT Setup Guide\n\nThis guide walks you through setting up HiveMQ Cloud MQTT broker for the BC Ferries telemetry system.\n\n## 🚀 Quick Start\n\n### 1. Create HiveMQ Cloud Account\n\n1. Go to [HiveMQ Cloud](https://console.hivemq.cloud/)\n2. Sign up for a free account\n3. Click \"Create Serverless Cluster\"\n4. Choose a cluster name (e.g., \"bc-ferries-demo\")\n5. Select your preferred region (recommend US-East for best performance)\n6. Click \"Create\"\n\n### 2. Configure Access Credentials\n\n1. In your HiveMQ Cloud console, click on your cluster\n2. Go to **Access Management** tab\n3. Click **Edit** in the Credentials section\n4. Click **Add Credentials**\n5. Create credentials:\n   - **Username**: `bc-ferries-telemetry`\n   - **Password**: Generate a strong password\n   - **Permissions**: Select \"Publish and Subscribe\"\n6. Save the credentials\n\n### 3. Get Connection Details\n\n1. In the **Overview** tab of your cluster\n2. Note down:\n   - **Cluster URL** (e.g., `abc123def.s1.eu.hivemq.cloud`)\n   - **Port**: `8883` (for TLS/SSL)\n   - **Protocol**: `MQTTS`\n\n### 4. Configure Environment Variables\n\n1. Copy `.env.example` to `.env`:\n   ```bash\n   cp .env.example .env\n   ```\n\n2. Edit `.env` with your HiveMQ Cloud details:\n   ```bash\n   HIVEMQ_CLUSTER_URL=your-cluster-url.s1.eu.hivemq.cloud\n   HIVEMQ_USERNAME=bc-ferries-telemetry\n   HIVEMQ_PASSWORD=your-secure-password\n   ```\n\n### 5. Test the Connection\n\n```bash\n# Install dependencies\nnpm install\n\n# Run the MQTT connection test\nnode scripts/test-mqtt-connection.js\n```\n\n## 📡 MQTT Topic Structure\n\nThe BC Ferries telemetry system uses a hierarchical topic structure following maritime industry standards:\n\n### Topic Patterns\n\n| Message Type | Topic Pattern | QoS | Retain | Description |\n|--------------|---------------|-----|--------|--------------|\n| **Telemetry** | `fleet/bcferries/{vesselId}/telemetry` | 1 | false | Real-time vessel data |\n| **Emergency** | `fleet/bcferries/{vesselId}/emergency/{type}` | 2 | false | Critical alerts |\n| **Control** | `fleet/bcferries/{vesselId}/control/{system}/{action}` | 1 | false | Remote commands |\n| **Status** | `fleet/bcferries/{vesselId}/status/{component}` | 1 | true | System status updates |\n| **Heartbeat** | `fleet/bcferries/{vesselId}/heartbeat` | 0 | false | Keep-alive messages |\n\n### Example Topics\n\n```\nfleet/bcferries/island-class-001/telemetry\nfleet/bcferries/island-class-001/emergency/fire\nfleet/bcferries/island-class-001/control/engine/set_rpm\nfleet/bcferries/island-class-001/status/systems\nfleet/bcferries/island-class-001/heartbeat\n```\n\n## 📋 Message Formats\n\n### Telemetry Message\n\n```json\n{\n  \"vesselId\": \"island-class-001\",\n  \"timestamp\": \"2025-08-31T12:00:00.000Z\",\n  \"messageId\": \"550e8400-e29b-41d4-a716-446655440000\",\n  \"location\": {\n    \"latitude\": 48.6569,\n    \"longitude\": -123.3933,\n    \"heading\": 45\n  },\n  \"engine\": {\n    \"rpm\": 1200,\n    \"temperature\": 85,\n    \"fuelFlow\": 120\n  },\n  \"power\": {\n    \"batterySOC\": 85,\n    \"mode\": \"hybrid\",\n    \"generatorLoad\": 45\n  },\n  \"safety\": {\n    \"fireAlarm\": false,\n    \"bilgeLevel\": 15,\n    \"co2Level\": 400\n  },\n  \"navigation\": {\n    \"speed\": 12.5,\n    \"route\": \"SWB-TSA\",\n    \"nextWaypoint\": \"Active Pass\"\n  }\n}\n```\n\n### Emergency Message\n\n```json\n{\n  \"vesselId\": \"island-class-001\",\n  \"timestamp\": \"2025-08-31T12:00:00.000Z\",\n  \"messageId\": \"550e8400-e29b-41d4-a716-446655440001\",\n  \"emergency\": true,\n  \"type\": \"fire\",\n  \"severity\": \"critical\",\n  \"message\": \"Fire alarm activated - engine power reduced\",\n  \"location\": {\n    \"latitude\": 48.6569,\n    \"longitude\": -123.3933\n  },\n  \"response\": {\n    \"required\": true,\n    \"estimated_eta\": 900\n  }\n}\n```\n\n### Control Message\n\n```json\n{\n  \"vesselId\": \"island-class-001\",\n  \"system\": \"engine\",\n  \"action\": \"set_rpm\",\n  \"payload\": {\n    \"value\": 1500,\n    \"authority\": \"operations-center\",\n    \"reason\": \"speed_adjustment\"\n  },\n  \"timestamp\": \"2025-08-31T12:00:00.000Z\"\n}\n```\n\n## 🔒 Security Configuration\n\n### TLS/SSL Settings\n\nThe MQTT client is configured with enterprise-grade security:\n\n- **Protocol**: MQTTS (MQTT over TLS)\n- **Port**: 8883\n- **TLS Version**: 1.2/1.3\n- **Certificate Validation**: Enabled\n- **Mutual TLS**: Optional (not required for HiveMQ Cloud)\n\n### Authentication\n\n- **Method**: Username/Password\n- **Username**: Your HiveMQ Cloud username\n- **Password**: Your HiveMQ Cloud password\n- **Client ID**: Auto-generated with vessel prefix\n\n### Connection Security\n\n```javascript\nconst connectOptions = {\n  clientId: 'bc-ferries-' + uuid(),\n  username: process.env.HIVEMQ_USERNAME,\n  password: process.env.HIVEMQ_PASSWORD,\n  protocol: 'mqtts',\n  port: 8883,\n  rejectUnauthorized: true,  // Validate server certificate\n  protocolVersion: 5,        // MQTT 5.0\n  keepalive: 60,            // Keep connection alive\n  clean: true,              // Clean session\n  reconnectPeriod: 5000     // Auto-reconnect\n}\n```\n\n## 🔧 Advanced Configuration\n\n### Message Quality of Service (QoS)\n\n- **QoS 0** (At most once): Heartbeat messages\n- **QoS 1** (At least once): Telemetry, control, status\n- **QoS 2** (Exactly once): Emergency messages\n\n### Retry Logic\n\n- **Max Retries**: 3 attempts\n- **Backoff Strategy**: Exponential (5s, 10s, 20s)\n- **Message Expiry**: 5 minutes\n- **Duplicate Detection**: Enabled\n\n### Connection Management\n\n- **Keep Alive**: 60 seconds\n- **Connect Timeout**: 30 seconds\n- **Reconnect Period**: 5 seconds\n- **Max Reconnect Attempts**: 10\n\n### Message Buffering\n\nWhen disconnected, messages are buffered in memory:\n\n- **Buffer Size**: Unlimited (memory permitting)\n- **Buffer Duration**: Until reconnection\n- **Flush Strategy**: FIFO on reconnect\n- **Persistent Storage**: Not implemented (memory only)\n\n## 🔍 Monitoring & Debugging\n\n### Connection Health Check\n\n```bash\ncurl http://localhost:8080/health\n```\n\nResponse:\n```json\n{\n  \"status\": \"healthy\",\n  \"mqtt\": {\n    \"connected\": true,\n    \"broker\": \"mqtts://your-cluster.hivemq.cloud:8883\",\n    \"clientId\": \"bc-ferries-uuid\",\n    \"reconnectAttempts\": 0,\n    \"bufferedMessages\": 0,\n    \"lastHeartbeat\": 1693478400000\n  }\n}\n```\n\n### Logging Configuration\n\nSet environment variables for detailed logging:\n\n```bash\nLOG_LEVEL=debug\nLOG_MQTT_EVENTS=true\n```\n\n### HiveMQ Cloud Console\n\n1. Monitor connection status in real-time\n2. View message rates and throughput\n3. Check client connections and subscriptions\n4. Monitor data usage against quota\n\n## 🚨 Troubleshooting\n\n### Common Issues\n\n#### \"Connection refused\" Error\n\n```\nError: connect ECONNREFUSED\n```\n\n**Solution**:\n- Verify `HIVEMQ_CLUSTER_URL` is correct\n- Check firewall/proxy settings\n- Ensure port 8883 is accessible\n\n#### \"Not authorized\" Error\n\n```\nError: Connection refused, not authorized\n```\n\n**Solution**:\n- Verify `HIVEMQ_USERNAME` and `HIVEMQ_PASSWORD`\n- Check credential permissions in HiveMQ console\n- Ensure credentials are active\n\n#### \"DNS resolution failed\" Error\n\n```\nError: getaddrinfo ENOTFOUND\n```\n\n**Solution**:\n- Check cluster URL format (no `https://` prefix)\n- Verify internet connectivity\n- Try different DNS servers\n\n#### Messages Not Publishing\n\n**Symptoms**: No errors, but messages don't appear\n\n**Solution**:\n- Check topic permissions\n- Verify QoS settings\n- Monitor HiveMQ console for message rates\n- Check message size limits\n\n### Diagnostic Commands\n\n```bash\n# Test MQTT connection\nnode scripts/test-mqtt-connection.js\n\n# Check system connectivity\ntelnet your-cluster.hivemq.cloud 8883\n\n# View real-time logs\ntail -f logs/mqtt.log\n\n# Check environment configuration\nnode -e \"console.log(process.env.HIVEMQ_CLUSTER_URL)\"\n```\n\n## 📊 Performance Guidelines\n\n### Message Rates\n\n- **Telemetry**: Every 60 seconds\n- **Heartbeat**: Every 30 seconds\n- **Status Updates**: On change + every 5 minutes\n- **Emergency**: Immediate\n\n### Payload Sizes\n\n- **Telemetry**: ~500-800 bytes\n- **Emergency**: ~200-400 bytes\n- **Control**: ~100-200 bytes\n- **Status**: ~300-500 bytes\n\n### Free Tier Limits\n\n- **Connections**: 100 concurrent\n- **Messages/Month**: 10 million\n- **Data Transfer**: 10 GB/month\n- **Message Size**: 256 KB max\n\n## 🔄 Integration with AWS IoT Core\n\nFor production deployments, consider bridging HiveMQ Cloud to AWS IoT Core:\n\n1. **HiveMQ Extension**: Use AWS IoT Core extension\n2. **Topic Mapping**: Map vessel topics to AWS IoT rules\n3. **Data Processing**: Use AWS Lambda for message processing\n4. **Storage**: Store in AWS IoT Analytics or DynamoDB\n5. **Monitoring**: CloudWatch metrics and alarms\n\n### Bridge Configuration Example\n\n```yaml\n# HiveMQ Cloud -> AWS IoT Core Bridge\nsource:\n  topic: \"fleet/bcferries/+/telemetry\"\n  qos: 1\ntarget:\n  topic: \"$aws/rules/ferry-telemetry\"\n  qos: 1\ntransformation:\n  - add_timestamp\n  - validate_schema\n  - enrich_metadata\n```\n\n## 📚 Additional Resources\n\n- [HiveMQ Cloud Documentation](https://docs.hivemq.com/hivemq-cloud/)\n- [MQTT 5.0 Specification](https://docs.oasis-open.org/mqtt/mqtt/v5.0/mqtt-v5.0.html)\n- [Maritime IoT Best Practices](https://www.imo.org/en/MediaCentre/PressBriefings/Pages/maritime-digitalization.aspx)\n- [BC Ferries Fleet Information](https://www.bcferries.com/our-fleet)\n\n## 🆘 Support\n\nFor technical issues:\n\n1. Check this documentation\n2. Run diagnostic tests\n3. Review HiveMQ Cloud console logs\n4. Contact [Murray Kopit](mailto:murr2k@gmail.com)\n\n---\n\n*Last updated: August 31, 2025*\n*Version: 1.0.0*